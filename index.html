<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <title>Link Whatsapp</title>

  <link rel="stylesheet" href="style.css">
</head>

<body>

  <header>
    <div class="navbar">
      <span>LKW</span>

      <div class="nb-buttons">
        <a href="https://github.com/joaoeymard/linkwhatsapp" target="_blank" rel="link para o projeto no github">
          <img src="images/github.svg" alt="icone do github">
        </a>
      </div>
    </div>
  </header>

  <main>
    <ul class="last-numbers">
    </ul>
  </main>

  <footer>
    <form class="frm-new-number" novalidate>
      <div>
        <label for="ws-number" class="lbl-number"></label>
        <input id="ws-number" class="npt-number" type="number" autocomplete="off">
      </div>
      <button type="submit" class="btn-ws">open on whatsapp</button>
    </form>
  </footer>

  <script>
    const $frmNewNumber = document.querySelector('.frm-new-number');
    const $btnWs = document.querySelector('.btn-ws');
    const $nptNumber = document.querySelector('.npt-number');
    const $lblNumber = document.querySelector('.lbl-number');
    const $lastNumbers = document.querySelector('.last-numbers');

    const setMask = (value, mask, ini = 0) => mask.replace(/\*/g, () => value[ini++] || '');
    const onlyNumbers = (number) => (String(number).match(/\d+/g) || []).join('');
    const openWhats = (number) => window.open(`https://wa.me/55${number}`, '_blank');
    const formatTime = (date) => new Date(date).toLocaleString('pt-br');

    const saveNumber = (strNumber) => {
      const listLastNumbers = JSON.parse(localStorage.getItem('numbers') || '[]');

      listLastNumbers.unshift({
        phone: strNumber,
        time: Date.now()
      });

      localStorage.setItem('numbers', JSON.stringify(listLastNumbers.splice(0, 5)));
    }

    const showLastNumbers = () => {
      const listLastNumbers = JSON.parse(localStorage.getItem('numbers') || '[]');

      $lastNumbers.textContent = '';
      listLastNumbers.forEach(number => {
        $lastNumbers.innerHTML = $lastNumbers.innerHTML + `
          <li onclick="openWhats(${onlyNumbers(number.phone)})">
            <p class="number">${number.phone}</p>
            <span class="time">${formatTime(number.time)}</span>
          </li>
        `
      });
    }

    const evtMaskPhone = (ev) => {
      const phoneNumber = onlyNumbers(ev.target.value);

      ev.target.value = phoneNumber.slice(0, 11);

      if (phoneNumber.length < 3) {
        $lblNumber.textContent = phoneNumber;
      } else if (phoneNumber.length < 7) {
        $lblNumber.textContent = setMask(phoneNumber, '(**) ****');
      } else if (phoneNumber.length < 11) {
        $lblNumber.textContent = setMask(phoneNumber, '(**) ****-****');
      } else {
        $lblNumber.textContent = setMask(phoneNumber, '(**) *****-****');
      }
    }

    const clearInputNumber = () => {
      $frmNewNumber.reset();
      $lblNumber.textContent = '';
    }

    $frmNewNumber.addEventListener('submit', (ev) => {
      ev.preventDefault();

      saveNumber($lblNumber.textContent);
      showLastNumbers();
      clearInputNumber();
      openWhats(onlyNumbers($lblNumber.textContent));
    });

    $nptNumber.addEventListener('keyup', evtMaskPhone);
    $nptNumber.addEventListener('keydown', evtMaskPhone);

    window.onload = () => {
      showLastNumbers();
    }
  </script>
</body>

</html>